name: Salesforce CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  validate:
    name: Validate Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: Install sfdx-git-delta
        run: |
          echo y | sf plugins install sfdx-git-delta

      - name: Generate delta package
        run: |
          mkdir delta
          sf sgd source delta --to HEAD --from HEAD^ --output delta/ --source force-app/
          echo "--- Changed components ---"
          cat delta/package/package.xml

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > ./SFDX_AUTH_URL.txt
          sf org login sfdx-url --sfdx-url-file ./SFDX_AUTH_URL.txt --alias target-org --set-default
          rm ./SFDX_AUTH_URL.txt

      - name: Validate Deployment (Delta Only)
        run: |
          if [ -s delta/package/package.xml ]; then
            sf project deploy validate --manifest delta/package/package.xml --test-level NoTestRun --wait 20
          else
            echo "No changes to validate"
          fi

  deploy:
    name: Deploy to Salesforce
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: Install sfdx-git-delta
        run: |
          echo y | sf plugins install sfdx-git-delta

      - name: Generate delta package for deployment
        run: |
          mkdir delta
          sf sgd source delta --to HEAD --from HEAD~1 --output delta/ --source force-app/
          echo "--- Deploying these components ---"
          cat delta/package/package.xml

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > ./SFDX_AUTH_URL.txt
          sf org login sfdx-url --sfdx-url-file ./SFDX_AUTH_URL.txt --alias target-org --set-default
          rm ./SFDX_AUTH_URL.txt

      - name: Deploy to Salesforce (Delta Only)
        run: |
          if [ -s delta/package/package.xml ]; then
            sf project deploy start --manifest delta/package/package.xml --test-level NoTestRun --wait 20
          else
            echo "No changes to deploy"
          fi

      - name: Deployment Status
        if: always()
        run: echo "Deployment completed with status ${{ job.status }}"

  quick-deploy:
    name: Quick Deploy (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Salesforce CLI
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: Authenticate to Salesforce
        run: |
          echo "${{ secrets.SFDX_AUTH_URL }}" > ./SFDX_AUTH_URL.txt
          sf org login sfdx-url --sfdx-url-file ./SFDX_AUTH_URL.txt --alias target-org --set-default
          rm ./SFDX_AUTH_URL.txt

      - name: Quick Deploy
        run: sf project deploy start --source-dir force-app --wait 20
